name: Postura Backend Docker CD

on:
  push:
    branches: [ "main" ] # main 브랜치에 push될 때 실행됩니다.
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Docker Buildx 설정 (멀티 플랫폼 빌드 등 지원)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker 이미지 빌드 및 푸시
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: yswmon/postura-backend:latest
          file: ./Dockerfile

  deploy:
    needs: build-and-push # 빌드가 성공해야 배포를 시작합니다.
    runs-on: ubuntu-latest
    steps:
      - name: Execute remote ssh commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. 최신 이미지 가져오기
            sudo docker pull yswmon/postura-backend:latest
            
            # 2. 기존 컨테이너 중지 및 제거 (없어도 에러 안 나게 처리)
            sudo docker stop postura-backend || true
            sudo docker rm postura-backend || true
            
            # 3. 새 컨테이너 실행 (Secrets에서 가져온 환경변수 주입)
            sudo docker run -d -p 8080:8080 --name postura-backend \
              -e SPRING_DATASOURCE_URL='${{ secrets.DB_URL }}' \
              -e SPRING_DATASOURCE_USERNAME='${{ secrets.DB_USERNAME }}' \
              -e SPRING_DATASOURCE_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e SPRING_REDIS_HOST='${{ secrets.REDIS_HOST }}' \
              -e SPRING_REDIS_PORT='${{ secrets.REDIS_PORT }}' \
              -e KAKAO_CLIENT_ID='${{ secrets.KAKAO_ID }}' \
              -e KAKAO_CLIENT_SECRET='${{ secrets.KAKAO_SECRET }}' \
              -e GOOGLE_CLIENT_ID='${{ secrets.GOOGLE_ID }}' \
              -e GOOGLE_CLIENT_SECRET='${{ secrets.GOOGLE_SECRET }}' \
              yswmon/postura-backend:latest
            
            # 4. 안 쓰는 오래된 이미지 삭제
            sudo docker image prune -f